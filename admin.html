<!DOCTYPE html>
<html lang="bs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel ‚Äì Cyber Heroji</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="./quiz/quiz.css" />
  <style>
    :root {
      --admin-bg: #f5f7fa;
      --admin-card: #ffffff;
      --admin-border: #e1e8ed;
      --admin-text: #14171a;
      --admin-muted: #657786;
      --admin-primary: #0F6B52;
      --admin-accent: #D9B35A;
      --admin-danger: #e0245e;
      --admin-success: #17bf63;
      --admin-warning: #ffad1f;
    }

    body.dark-mode {
      --admin-bg: #0B1010;
      --admin-card: #0B2F28;
      --admin-border: rgba(255,255,255,0.16);
      --admin-text: #E9EEE9;
      --admin-muted: #8899A6;
    }

    body {
      background: var(--admin-bg);
      color: var(--admin-text);
      margin: 0;
      padding: 0;
      font-family: 'Montserrat', sans-serif;
    }

    /* ADMIN NAV */
    .admin-nav {
      background: var(--admin-card);
      border-bottom: 2px solid var(--admin-border);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .admin-logo {
      font-size: 1.4rem;
      font-weight: 900;
      color: var(--admin-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .admin-logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--admin-primary), var(--admin-accent));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }

    .admin-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    /* STATS CARDS */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--admin-card);
      border: 1px solid var(--admin-border);
      border-radius: 12px;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }

    .stat-icon {
      width: 56px;
      height: 56px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      flex-shrink: 0;
    }

    .stat-icon.primary { background: linear-gradient(135deg, var(--admin-primary), #0a5340); }
    .stat-icon.accent { background: linear-gradient(135deg, var(--admin-accent), #c29a3d); }
    .stat-icon.success { background: linear-gradient(135deg, var(--admin-success), #12a352); }
    .stat-icon.warning { background: linear-gradient(135deg, var(--admin-warning), #e69500); }

    .stat-content {
      flex: 1;
    }

    .stat-label {
      font-size: 0.85rem;
      color: var(--admin-muted);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 900;
      color: var(--admin-text);
      line-height: 1;
    }

    /* FILTERS */
    .filters {
      background: var(--admin-card);
      border: 1px solid var(--admin-border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex: 1;
      min-width: 200px;
    }

    .filter-label {
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--admin-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .filter-input {
      padding: 10px 14px;
      border: 2px solid var(--admin-border);
      border-radius: 8px;
      background: var(--admin-bg);
      color: var(--admin-text);
      font-family: inherit;
      font-size: 0.95rem;
      transition: border-color 0.2s ease;
    }

    .filter-input:focus {
      outline: none;
      border-color: var(--admin-primary);
    }

    /* TABLE */
    .data-table-wrapper {
      background: var(--admin-card);
      border: 1px solid var(--admin-border);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 24px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table thead {
      background: var(--admin-bg);
    }

    .data-table th {
      padding: 16px;
      text-align: left;
      font-size: 0.85rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--admin-muted);
      border-bottom: 2px solid var(--admin-border);
      white-space: nowrap;
    }

    .data-table td {
      padding: 14px 16px;
      border-bottom: 1px solid var(--admin-border);
      font-size: 0.95rem;
    }

    .data-table tbody tr:hover {
      background: var(--admin-bg);
    }

    .data-table tbody tr:last-child td {
      border-bottom: none;
    }

    /* BADGES */
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .badge.success {
      background: rgba(23, 191, 99, 0.15);
      color: var(--admin-success);
    }

    .badge.warning {
      background: rgba(255, 173, 31, 0.15);
      color: var(--admin-warning);
    }

    .badge.danger {
      background: rgba(224, 36, 94, 0.15);
      color: var(--admin-danger);
    }

    .badge.primary {
      background: rgba(15, 107, 82, 0.15);
      color: var(--admin-primary);
    }

    /* PROGRESS BAR */
    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--admin-border);
      border-radius: 999px;
      overflow: hidden;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--admin-primary), var(--admin-accent));
      border-radius: 999px;
      transition: width 0.3s ease;
    }

    /* ACTION BUTTONS */
    .btn-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: none;
      background: transparent;
      color: var(--admin-muted);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      font-size: 1rem;
    }

    .btn-icon:hover {
      background: var(--admin-bg);
      color: var(--admin-text);
    }

    .btn-icon.danger:hover {
      background: rgba(224, 36, 94, 0.15);
      color: var(--admin-danger);
    }

    /* MODAL */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: var(--admin-card);
      border-radius: 16px;
      padding: 30px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--admin-border);
    }

    .modal-title {
      font-size: 1.4rem;
      font-weight: 900;
      margin: 0;
    }

    .modal-close {
      width: 36px;
      height: 36px;
      border: none;
      background: var(--admin-bg);
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      color: var(--admin-muted);
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      background: var(--admin-border);
      color: var(--admin-text);
    }

    .modal-body {
      margin: 20px 0;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--admin-border);
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      font-weight: 700;
      color: var(--admin-muted);
    }

    .detail-value {
      font-weight: 600;
      color: var(--admin-text);
      text-align: right;
    }

    /* EMPTY STATE */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--admin-muted);
    }

    .empty-icon {
      font-size: 4rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-title {
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .empty-text {
      font-size: 0.95rem;
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .filters {
        flex-direction: column;
      }

      .filter-group {
        width: 100%;
      }

      .data-table-wrapper {
        overflow-x: auto;
      }

      .stat-card {
        flex-direction: column;
        text-align: center;
      }
    }

    /* CONTAINER */
    .admin-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }

    .section-title {
      font-size: 1.6rem;
      font-weight: 900;
      margin-bottom: 20px;
      color: var(--admin-text);
    }

    /* TABS */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 2px solid var(--admin-border);
    }

    .tab {
      padding: 12px 20px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-weight: 700;
      color: var(--admin-muted);
      border-bottom: 3px solid transparent;
      transition: all 0.2s ease;
      font-family: inherit;
      font-size: 0.95rem;
    }

    .tab:hover {
      color: var(--admin-text);
    }

    .tab.active {
      color: var(--admin-primary);
      border-bottom-color: var(--admin-primary);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <!-- NAV -->
  <nav class="admin-nav">
    <div class="admin-logo">
      <div class="admin-logo-icon">üõ°Ô∏è</div>
      <span>Cyber Heroji ‚Äì Admin Panel</span>
    </div>
    <div class="admin-actions">
      <button class="btn btn-outline" id="refreshBtn">üîÑ Refresh</button>
      <button class="btn btn-outline" id="exportBtn">üì• Export CSV</button>
      <button class="btn btn-color-2" id="themeToggle">üåô Dark</button>
      <a href="./quiz/" class="btn btn-primary">‚Ü© Nazad na kvizove</a>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="admin-container">
    <!-- STATS -->
    <div class="stats-grid" id="statsGrid"></div>

    <!-- TABS -->
    <div class="tabs">
      <button class="tab active" data-tab="results">üìä Svi rezultati</button>
      <button class="tab" data-tab="students">üë• Uƒçenici</button>
      <button class="tab" data-tab="certificates">üèÜ Sertifikati</button>
      <button class="tab" data-tab="topics">üìö Teme</button>
    </div>

    <!-- TAB: RESULTS -->
    <div class="tab-content active" id="results">
      <h2 class="section-title">Svi rezultati</h2>

      <!-- FILTERS -->
      <div class="filters">
        <div class="filter-group">
          <label class="filter-label">Pretraga uƒçenika</label>
          <input type="text" class="filter-input" id="searchStudent" placeholder="Unesi ime uƒçenika..." />
        </div>
        <div class="filter-group">
          <label class="filter-label">Grupa</label>
          <select class="filter-input" id="filterGroup">
            <option value="">Sve grupe</option>
            <option value="A">Grupa A (9-11)</option>
            <option value="B">Grupa B (12-15)</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Status</label>
          <select class="filter-input" id="filterStatus">
            <option value="">Svi statusi</option>
            <option value="passed">Passed</option>
            <option value="failed">Failed</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">Tema</label>
          <select class="filter-input" id="filterTopic">
            <option value="">Sve teme</option>
          </select>
        </div>
      </div>

      <!-- TABLE -->
      <div class="data-table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>Uƒçenik</th>
              <th>Grupa</th>
              <th>Tema</th>
              <th>Kviz</th>
              <th>Score</th>
              <th>Status</th>
              <th>Datum</th>
              <th>Akcije</th>
            </tr>
          </thead>
          <tbody id="resultsTable"></tbody>
        </table>
      </div>
    </div>

    <!-- TAB: STUDENTS -->
    <div class="tab-content" id="students">
      <h2 class="section-title">Pregled uƒçenika</h2>
      <div class="data-table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>Uƒçenik</th>
              <th>Grupa</th>
              <th>Ukupno kvizova</th>
              <th>Polo≈æeno</th>
              <th>Prosjeƒçan score</th>
              <th>Napredak</th>
              <th>Sertifikat</th>
              <th>Akcije</th>
            </tr>
          </thead>
          <tbody id="studentsTable"></tbody>
        </table>
      </div>
    </div>

    <!-- TAB: CERTIFICATES -->
    <div class="tab-content" id="certificates">
      <h2 class="section-title">Izdati sertifikati</h2>
      <div class="data-table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>Uƒçenik</th>
              <th>Grupa</th>
              <th>Titula</th>
              <th>Kljuƒçeva</th>
              <th>Ukupan score</th>
              <th>Datum</th>
              <th>Akcije</th>
            </tr>
          </thead>
          <tbody id="certificatesTable"></tbody>
        </table>
      </div>
    </div>

    <!-- TAB: TOPICS -->
    <div class="tab-content" id="topics">
      <h2 class="section-title">Statistike po temama</h2>
      <div class="data-table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>Tema</th>
              <th>Ukupno poku≈°aja</th>
              <th>Prosjeƒçan score</th>
              <th>Pass rate</th>
              <th>Najpopularniji kviz</th>
            </tr>
          </thead>
          <tbody id="topicsTable"></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- MODAL: DETAIL -->
  <div class="modal" id="detailModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Detalji rezultata</h3>
        <button class="modal-close" onclick="closeModal()">‚úï</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
      <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:24px;">
        <button class="btn btn-outline" onclick="closeModal()">Zatvori</button>
        <button class="btn btn-danger" id="deleteResultBtn">üóëÔ∏è Obri≈°i rezultat</button>
      </div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script src="./quiz/data.js"></script>
  <script>
    // =============================
    // THEME TOGGLE
    // =============================
    function setTheme(isDark){
      if(isDark) document.body.classList.add("dark-mode");
      else document.body.classList.remove("dark-mode");
      localStorage.setItem("adminDarkMode", String(isDark));
      const t = document.getElementById("themeToggle");
      if(t) t.innerText = isDark ? "‚òÄÔ∏è Light" : "üåô Dark";
    }

    function initTheme(){
      const saved = localStorage.getItem("adminDarkMode");
      const isDark = saved === "true";
      setTheme(isDark);
      const t = document.getElementById("themeToggle");
      if(t){
        t.addEventListener("click", ()=> setTheme(!document.body.classList.contains("dark-mode")));
      }
    }

    // =============================
    // DATA LOADING
    // =============================
    function getAllResults(){
      const results = [];
      const keys = Object.keys(localStorage);
      keys.forEach(k=>{
        if(k.startsWith("cyberedu_result__")){
          try{
            const data = JSON.parse(localStorage.getItem(k));
            data._key = k;
            results.push(data);
          }catch(e){}
        }
      });
      return results;
    }

    function getStudents(){
      const results = getAllResults();
      const studentMap = {};

      results.forEach(r=>{
        const key = r.student + "__" + r.group;
        if(!studentMap[key]){
          studentMap[key] = {
            student: r.student,
            group: r.group,
            quizzes: [],
            totalScore: 0,
            passed: 0
          };
        }
        studentMap[key].quizzes.push(r);
        studentMap[key].totalScore += r.score;
        if(r.passed) studentMap[key].passed++;
      });

      return Object.values(studentMap).map(s=>{
        s.avgScore = s.quizzes.length ? Math.round(s.totalScore / s.quizzes.length) : 0;
        s.keys = [...new Set(s.quizzes.filter(q=>q.passed).map(q=>q.key))].length;
        s.eligible = s.keys >= 10;
        return s;
      });
    }

    function getCertificates(){
      const students = getStudents();
      return students.filter(s=>s.eligible).map(s=>{
        const title = s.group === "A" ? "Junior Cyber Explorer" : "Young Cyber Defender";
        const lastQuiz = s.quizzes[s.quizzes.length - 1];
        return {
          student: s.student,
          group: s.group,
          title,
          keys: s.keys,
          totalScore: s.totalScore,
          date: lastQuiz ? lastQuiz.when : null
        };
      });
    }

    function getTopicStats(){
      const results = getAllResults();
      const topicMap = {};

      QUIZ_DATA.topics.forEach(t=>{
        topicMap[t.id] = {
          title: t.title,
          attempts: 0,
          totalScore: 0,
          passed: 0,
          quizA: 0,
          quizB: 0
        };
      });

      results.forEach(r=>{
        if(topicMap[r.topicId]){
          topicMap[r.topicId].attempts++;
          topicMap[r.topicId].totalScore += r.score;
          if(r.passed) topicMap[r.topicId].passed++;
          if(r.part === "A") topicMap[r.topicId].quizA++;
          else topicMap[r.topicId].quizB++;
        }
      });

      return Object.values(topicMap).map(t=>{
        t.avgScore = t.attempts ? Math.round(t.totalScore / t.attempts) : 0;
        t.passRate = t.attempts ? Math.round((t.passed / t.attempts) * 100) : 0;
        t.popularQuiz = t.quizA >= t.quizB ? "Kviz A" : "Kviz B";
        return t;
      });
    }

    // =============================
    // STATS RENDERING
    // =============================
    function renderStats(){
      const results = getAllResults();
      const students = getStudents();
      const certificates = getCertificates();
      const passed = results.filter(r=>r.passed).length;
      const avgScore = results.length ? Math.round(results.reduce((sum,r)=>sum+r.score, 0) / results.length) : 0;

      const html = `
        <div class="stat-card">
          <div class="stat-icon primary">üë•</div>
          <div class="stat-content">
            <div class="stat-label">Ukupno uƒçenika</div>
            <div class="stat-value">${students.length}</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon accent">üìù</div>
          <div class="stat-content">
            <div class="stat-label">Ukupno kvizova</div>
            <div class="stat-value">${results.length}</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon success">‚úÖ</div>
          <div class="stat-content">
            <div class="stat-label">Polo≈æeno</div>
            <div class="stat-value">${passed}</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon warning">üèÜ</div>
          <div class="stat-content">
            <div class="stat-label">Sertifikati</div>
            <div class="stat-value">${certificates.length}</div>
          </div>
        </div>
      `;

      document.getElementById("statsGrid").innerHTML = html;
    }

    // =============================
    // RESULTS TABLE
    // =============================
    let allResults = [];
    let filteredResults = [];

    function renderResultsTable(){
      const tbody = document.getElementById("resultsTable");
      
      if(!filteredResults.length){
        tbody.innerHTML = `
          <tr><td colspan="8">
            <div class="empty-state">
              <div class="empty-icon">üì≠</div>
              <div class="empty-title">Nema rezultata</div>
              <div class="empty-text">Nema rezultata koji odgovaraju filterima.</div>
            </div>
          </td></tr>
        `;
        return;
      }

      tbody.innerHTML = filteredResults.map(r=>{
        const statusClass = r.passed ? "success" : "danger";
        const statusText = r.passed ? "PASSED" : "FAILED";
        const date = r.when ? new Date(r.when).toLocaleDateString("bs-BA") : "‚Äî";

        return `
          <tr>
            <td><strong>${r.student}</strong></td>
            <td><span class="badge primary">${r.group}</span></td>
            <td>${r.topicTitle || "‚Äî"}</td>
            <td><span class="badge">Kviz ${r.part}</span></td>
            <td><strong>${r.score}/100</strong></td>
            <td><span class="badge ${statusClass}">${statusText}</span></td>
            <td>${date}</td>
            <td>
              <button class="btn-icon" onclick="showDetail('${r._key}')" title="Detalji">üëÅÔ∏è</button>
              <button class="btn-icon danger" onclick="deleteResult('${r._key}')" title="Obri≈°i">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      }).join("");
    }

    function applyFilters(){
      const search = document.getElementById("searchStudent").value.toLowerCase();
      const group = document.getElementById("filterGroup").value;
      const status = document.getElementById("filterStatus").value;
      const topic = document.getElementById("filterTopic").value;

      filteredResults = allResults.filter(r=>{
        if(search && !r.student.toLowerCase().includes(search)) return false;
        if(group && r.group !== group) return false;
        if(status === "passed" && !r.passed) return false;
        if(status === "failed" && r.passed) return false;
        if(topic && r.topicId !== topic) return false;
        return true;
      });

      renderResultsTable();
    }

    function initResultsTab(){
      allResults = getAllResults().sort((a,b)=> new Date(b.when) - new Date(a.when));
      filteredResults = allResults;

      // Populate topic filter
      const topicFilter = document.getElementById("filterTopic");
      QUIZ_DATA.topics.forEach(t=>{
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = t.title;
        topicFilter.appendChild(opt);
      });

      // Event listeners
      document.getElementById("searchStudent").addEventListener("input", applyFilters);
      document.getElementById("filterGroup").addEventListener("change", applyFilters);
      document.getElementById("filterStatus").addEventListener("change", applyFilters);
      document.getElementById("filterTopic").addEventListener("change", applyFilters);

      renderResultsTable();
    }

    // =============================
    // STUDENTS TABLE
    // =============================
    function renderStudentsTable(){
      const students = getStudents();
      const tbody = document.getElementById("studentsTable");

      if(!students.length){
        tbody.innerHTML = `
          <tr><td colspan="8">
            <div class="empty-state">
              <div class="empty-icon">üë•</div>
              <div class="empty-title">Nema uƒçenika</div>
              <div class="empty-text">Jo≈° nema uƒçenika koji su uradili kvizove.</div>
            </div>
          </td></tr>
        `;
        return;
      }

      tbody.innerHTML = students.map(s=>{
        const progress = Math.round((s.keys / 10) * 100);
        const certBadge = s.eligible 
          ? `<span class="badge success">‚úÖ Izdat</span>` 
          : `<span class="badge warning">${s.keys}/10</span>`;

        return `
          <tr>
            <td><strong>${s.student}</strong></td>
            <td><span class="badge primary">${s.group}</span></td>
            <td>${s.quizzes.length}</td>
            <td>${s.passed}</td>
            <td><strong>${s.avgScore}/100</strong></td>
            <td>
              <div class="progress-bar">
                <div class="progress-fill" style="width:${progress}%"></div>
              </div>
              <small style="color:var(--admin-muted); font-size:0.8rem;">${progress}%</small>
            </td>
            <td>${certBadge}</td>
            <td>
              ${s.eligible ? `<a href="./quiz/certificate.html?student=${encodeURIComponent(s.student)}&group=${s.group}" class="btn-icon" title="Vidi sertifikat">üèÜ</a>` : ''}
              <button class="btn-icon danger" onclick="deleteStudent('${s.student}','${s.group}')" title="Obri≈°i uƒçenika">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      }).join("");
    }

    // =============================
    // CERTIFICATES TABLE
    // =============================
    function renderCertificatesTable(){
      const certificates = getCertificates();
      const tbody = document.getElementById("certificatesTable");

      if(!certificates.length){
        tbody.innerHTML = `
          <tr><td colspan="7">
            <div class="empty-state">
              <div class="empty-icon">üèÜ</div>
              <div class="empty-title">Nema izdatih sertifikata</div>
              <div class="empty-text">Jo≈° niko nije sakupio 10 kljuƒçeva.</div>
            </div>
          </td></tr>
        `;
        return;
      }

      tbody.innerHTML = certificates.map(c=>{
        const date = c.date ? new Date(c.date).toLocaleDateString("bs-BA") : "‚Äî";

        return `
          <tr>
            <td><strong>${c.student}</strong></td>
            <td><span class="badge primary">${c.group}</span></td>
            <td><span class="badge success">${c.title}</span></td>
            <td><strong>${c.keys}/10</strong></td>
            <td>${c.totalScore}</td>
            <td>${date}</td>
            <td>
              <a href="./quiz/certificate.html?student=${encodeURIComponent(c.student)}&group=${c.group}" class="btn-icon" title="Vidi sertifikat">üëÅÔ∏è</a>
              <a href="./quiz/certificate.html?student=${encodeURIComponent(c.student)}&group=${c.group}" class="btn-icon" title="≈†tampaj">üñ®Ô∏è</a>
            </td>
          </tr>
        `;
      }).join("");
    }

    // =============================
    // TOPICS TABLE
    // =============================
    function renderTopicsTable(){
      const topics = getTopicStats();
      const tbody = document.getElementById("topicsTable");

      tbody.innerHTML = topics.map(t=>{
        const passColor = t.passRate >= 70 ? "success" : t.passRate >= 50 ? "warning" : "danger";

        return `
          <tr>
            <td><strong>${t.title}</strong></td>
            <td>${t.attempts}</td>
            <td><strong>${t.avgScore}/100</strong></td>
            <td><span class="badge ${passColor}">${t.passRate}%</span></td>
            <td>${t.popularQuiz}</td>
          </tr>
        `;
      }).join("");
    }

    // =============================
    // MODAL
    // =============================
    let currentDetailKey = null;

    function showDetail(key){
      const data = JSON.parse(localStorage.getItem(key));
      currentDetailKey = key;

      const statusClass = data.passed ? "success" : "danger";
      const statusText = data.passed ? "‚úÖ PASSED" : "‚ùå FAILED";
      const date = data.when ? new Date(data.when).toLocaleString("bs-BA") : "‚Äî";

      const html = `
        <div class="detail-row">
          <span class="detail-label">Uƒçenik:</span>
          <span class="detail-value"><strong>${data.student}</strong></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Grupa:</span>
          <span class="detail-value"><span class="badge primary">${data.group}</span></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Tema:</span>
          <span class="detail-value">${data.topicTitle}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Soba:</span>
          <span class="detail-value">${data.room}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Kviz:</span>
          <span class="detail-value"><span class="badge">Kviz ${data.part}</span></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Score:</span>
          <span class="detail-value"><strong style="font-size:1.4rem;">${data.score}/100</strong></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Status:</span>
          <span class="detail-value"><span class="badge ${statusClass}">${statusText}</span></span>
        </div>
        ${data.passed ? `
        <div class="detail-row">
          <span class="detail-label">Kljuƒç:</span>
          <span class="detail-value"><strong style="color:var(--admin-accent); font-size:1.2rem;">üîë ${data.key}</strong></span>
        </div>
        ` : ''}
        <div class="detail-row">
          <span class="detail-label">Datum:</span>
          <span class="detail-value">${date}</span>
        </div>
        ${data.autoFinish ? `
        <div class="detail-row">
          <span class="detail-label">Naƒçin zavr≈°etka:</span>
          <span class="detail-value"><span class="badge warning">‚è±Ô∏è Auto (isteklo vrijeme)</span></span>
        </div>
        ` : ''}
      `;

      document.getElementById("modalBody").innerHTML = html;
      document.getElementById("detailModal").classList.add("show");
    }

    function closeModal(){
      document.getElementById("detailModal").classList.remove("show");
      currentDetailKey = null;
    }

    function deleteResult(key){
      if(!confirm("Da li ste sigurni da ≈æelite obrisati ovaj rezultat?")) return;
      localStorage.removeItem(key);
      refresh();
    }

    function deleteStudent(student, group){
      if(!confirm(`Da li ste sigurni da ≈æelite obrisati SVE rezultate za uƒçenika "${student}" (Grupa ${group})?`)) return;
      
      const keys = Object.keys(localStorage);
      keys.forEach(k=>{
        if(k.startsWith("cyberedu_result__")){
          try{
            const data = JSON.parse(localStorage.getItem(k));
            if(data.student === student && data.group === group){
              localStorage.removeItem(k);
            }
          }catch(e){}
        }
      });

      refresh();
    }

    document.getElementById("deleteResultBtn").addEventListener("click", ()=>{
      if(currentDetailKey){
        deleteResult(currentDetailKey);
        closeModal();
      }
    });

    // =============================
    // EXPORT CSV
    // =============================
    function exportCSV(){
      const results = getAllResults();
      if(!results.length){
        alert("Nema podataka za export!");
        return;
      }

      const headers = ["Uƒçenik", "Grupa", "Tema", "Kviz", "Score", "Status", "Kljuƒç", "Datum"];
      const rows = results.map(r=>[
        r.student,
        r.group,
        r.topicTitle || "",
        "Kviz " + r.part,
        r.score,
        r.passed ? "PASSED" : "FAILED",
        r.key || "",
        r.when ? new Date(r.when).toLocaleString("bs-BA") : ""
      ]);

      const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(",")).join("\n");
      const blob = new Blob(["\ufeff" + csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = `cyber_heroji_rezultati_${new Date().toISOString().split("T")[0]}.csv`;
      link.click();
      URL.revokeObjectURL(url);
    }

    document.getElementById("exportBtn").addEventListener("click", exportCSV);

    // =============================
    // TABS
    // =============================
    function initTabs(){
      const tabs = document.querySelectorAll(".tab");
      const contents = document.querySelectorAll(".tab-content");

      tabs.forEach(tab=>{
        tab.addEventListener("click", ()=>{
          const target = tab.dataset.tab;

          tabs.forEach(t=> t.classList.remove("active"));
          contents.forEach(c=> c.classList.remove("active"));

          tab.classList.add("active");
          document.getElementById(target).classList.add("active");
        });
      });
    }

    // =============================
    // REFRESH
    // =============================
    function refresh(){
      renderStats();
      initResultsTab();
      renderStudentsTable();
      renderCertificatesTable();
      renderTopicsTable();
    }

    document.getElementById("refreshBtn").addEventListener("click", refresh);

    // =============================
    // INIT
    // =============================
    document.addEventListener("DOMContentLoaded", ()=>{
      initTheme();
      initTabs();
      refresh();
    });

    // Close modal on outside click
    document.getElementById("detailModal").addEventListener("click", (e)=>{
      if(e.target.id === "detailModal") closeModal();
    });
  </script>
</body>
</html>
